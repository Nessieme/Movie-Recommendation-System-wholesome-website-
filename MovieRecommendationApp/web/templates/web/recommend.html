{% extends 'web/base.html'%}
{% load static %} {# Ensure static is loaded for any images if you add them later #}

{% block title %}Recommendations{% endblock %}

{% block body %}

<div class="container-fluid" style="padding-top: 50px; padding-bottom: 30px;">
    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Recommendations for You</h2>

    {# Display messages from Django #}
    {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert" style="text-align: center;">
                {{ message }}
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        {# Left Column for Manual Recommendation Form - Adjusted to col-md-4 #}
        <div class="col-md-4">
            <div class="recommendation-form-card main-content-card">
                <h3 style="margin-top: 0; margin-bottom: 25px; color: #34495e;">Get Manual Recommendations</h3>
                <form method="post" id="manualRecForm" class="recommend-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="{{ form.recommendation_type.id_for_label }}">{{ form.recommendation_type.label }}</label>
                        <select name="{{ form.recommendation_type.name }}" id="{{ form.recommendation_type.id_for_label }}" class="form-control">
                            {% for value, text in form.recommendation_type.field.choices %}
                                <option value="{{ value }}" {% if form.recommendation_type.value == value %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" id="movie-select-group">
                        <label for="{{ form.movie.id_for_label }}">{{ form.movie.label }}</label>
                        <select name="{{ form.movie.name }}" id="{{ form.movie.id_for_label }}" class="form-control">
                            {% for movie_obj in form.movie.field.queryset %} {# Renamed loop var to avoid conflict #}
                                <option value="{{ movie_obj.pk }}" {% if form.movie.value|stringformat:"s" == movie_obj.pk|stringformat:"s" %}selected{% endif %}>{{ movie_obj.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" id="genre-select-group" style="display: none;">
                        <label for="{{ form.genre.id_for_label }}">{{ form.genre.label }}</label>
                        <select name="{{ form.genre.name }}" id="{{ form.genre.id_for_label }}" class="form-control">
                            {% for value, text in form.genre.field.choices %}
                                <option value="{{ value }}" {% if form.genre.value == value %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.num_recommendations.id_for_label }}">{{ form.num_recommendations.label }}</label>
                        <input type="range" name="{{ form.num_recommendations.name }}" 
                               id="{{ form.num_recommendations.id_for_label }}" 
                               min="5" max="20" value="{{ form.num_recommendations.value|default:10 }}" 
                               class="form-control" oninput="this.nextElementSibling.value = this.value">
                        <output>{{ form.num_recommendations.value|default:10 }}</output>
                    </div>
                    <button type="submit" class="btn btn-primary-custom btn-block mt-4">Get Manual Recommendations</button>
                </form>
            </div>
        </div>

        {# Right Column for AI and Manual Movie Lists - Adjusted to col-md-8 #}
        <div class="col-md-8">
            {# Manual Recommendations (if available) #}
            {% if manual_movie_list %}
                <div class="recommendation-results-card main-content-card mb-4">
                    <h3 style="margin-top: 0; color: #34495e; margin-bottom: 25px;">Your Manual Recommendations</h3>
                    <div class="row g-3"> {# Use g-3 for consistent gutter spacing #}
                        {% for movie in manual_movie_list %}
                            <div class="col-sm-6 col-md-4 col-lg-3"> {# Adjusted columns for better grid on smaller screens #}
                                <div class="movie-thumbnail-card thumbnail">
                                    <h4 class="movie-title">{{ movie.title }}</h4>
                                    <a href="{% url 'detail' movie.id %}">
                                        <img src="{{ movie.movie_logo.url }}" class="img-responsive movie-logo">
                                    </a>
                                    <h5 class="movie-genre">{{ movie.genre }}</h5>
                                    
                                    {# Average Rating and Count #}
                                    <div class="movie-ratings-summary">
                                        {% if movie.average_rating %}
                                            <div class="star-rating-display">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= movie.average_rating|floatformat:"0" %}
                                                        <i class="fa fa-star star-filled"></i>
                                                    {% else %}
                                                        <i class="fa fa-star-o star-empty"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <span class="average-rating-value">{{ movie.average_rating|floatformat:1 }}</span>
                                            </div>
                                            <p class="rating-count-text">({{ movie.rating_count }} Users Rated)</p>
                                        {% else %}
                                            <p class="no-ratings-text">No ratings yet.</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="caption">
                                        <a href="{% url 'detail' movie.id %}" class="btn btn-secondary-custom btn-sm" role="button">Give Rating</a>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="col-xs-12 text-muted text-center">No movies found for your manual selection.</p>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {# AI Recommendations (Always available or fallback to popular) #}
            <div class="recommendation-results-card main-content-card">
                <h3 style="margin-top: 0; color: #34495e; margin-bottom: 25px;">AI-Powered Recommendations For You</h3>
                {% if ai_movie_list %}
                    <div class="row g-3"> {# Use g-3 for consistent gutter spacing #}
                        {% for movie in ai_movie_list %}
                            <div class="col-sm-6 col-md-4 col-lg-3"> {# Adjusted columns for better grid on smaller screens #}
                                <div class="movie-thumbnail-card thumbnail">
                                    <h4 class="movie-title">{{ movie.title }}</h4>
                                    <a href="{% url 'detail' movie.id %}">
                                        <img src="{{ movie.movie_logo.url }}" class="img-responsive movie-logo">
                                    </a>
                                    <h5 class="movie-genre">{{ movie.genre }}</h5>
                                    
                                    {# Average Rating and Count #}
                                    <div class="movie-ratings-summary">
                                        {% if movie.average_rating %}
                                            <div class="star-rating-display">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= movie.average_rating|floatformat:"0" %}
                                                        <i class="fa fa-star star-filled"></i>
                                                    {% else %}
                                                        <i class="fa fa-star-o star-empty"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <span class="average-rating-value">{{ movie.average_rating|floatformat:1 }}</span>
                                            </div>
                                            <p class="rating-count-text">({{ movie.rating_count }} Users Rated)</p>
                                        {% else %}
                                            <p class="no-ratings-text">No ratings yet.</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="caption">
                                        <a href="{% url 'detail' movie.id %}" class="btn btn-secondary-custom btn-sm" role="button">Give Rating</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">No AI recommendations available at this time. Please rate some movies!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var recTypeSelect = document.getElementById('id_recommendation_type');
    var movieGroup = document.getElementById('movie-select-group');
    var genreGroup = document.getElementById('genre-select-group');

    function toggleGroups() {
        if (recTypeSelect.value === 'movie') {
            movieGroup.style.display = 'block';
            genreGroup.style.display = 'none';
            // Ensure required is set correctly for selected type and cleared for hidden type
            document.getElementById('{{ form.movie.id_for_label }}').required = true;
            document.getElementById('{{ form.genre.id_for_label }}').required = false;
            document.getElementById('{{ form.genre.id_for_label }}').value = ''; // Clear genre selection
        } else {
            movieGroup.style.display = 'none';
            genreGroup.style.display = 'block';
            document.getElementById('{{ form.movie.id_for_label }}').required = false;
            document.getElementById('{{ form.genre.id_for_label }}').required = true;
            document.getElementById('{{ form.movie.id_for_label }}').value = ''; // Clear movie selection
        }
    }

    // Run on page load
    toggleGroups();

    // Run when selection changes
    recTypeSelect.addEventListener('change', toggleGroups);
});
</script>
{% endblock %}